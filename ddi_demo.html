<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDI Comprehensive Analyzer</title>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:system-ui,-apple-system,sans-serif;background:#f0f2f5;min-height:100vh}
        .header{background:linear-gradient(135deg,#1a365d,#2563eb);color:#fff;padding:20px;text-align:center}
        .header h1{font-size:24px;margin-bottom:6px}
        .header p{font-size:13px;opacity:0.9}
        
        .main-container{max-width:1600px;margin:0 auto;padding:20px;display:grid;grid-template-columns:350px 1fr;gap:20px}
        
        .panel{background:#fff;border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,0.08);overflow:hidden}
        .panel-header{background:linear-gradient(135deg,#f8fafc,#e2e8f0);padding:14px 18px;border-bottom:1px solid #e2e8f0;font-weight:600;font-size:15px;display:flex;justify-content:space-between;align-items:center}
        .panel-content{padding:18px}
        
        /* Left Sidebar */
        .sidebar{display:flex;flex-direction:column;gap:20px}
        
        /* Input Section */
        .drug-input{margin-bottom:15px}
        .drug-input label{display:block;font-size:13px;font-weight:600;margin-bottom:8px;color:#374151}
        .drug-input input{width:100%;padding:12px 14px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;transition:border-color 0.2s}
        .drug-input input:focus{outline:none;border-color:#2563eb}
        .hint{color:#6b7280;font-size:11px;margin-top:6px}
        
        /* Buttons */
        .btn{padding:12px 20px;border:none;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}
        .btn:hover{transform:translateY(-1px)}
        .btn:active{transform:translateY(0)}
        .btn-primary{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;box-shadow:0 4px 14px rgba(37,99,235,0.3)}
        .btn-primary:hover{box-shadow:0 6px 20px rgba(37,99,235,0.4)}
        .btn-report{background:linear-gradient(135deg,#059669,#047857);color:#fff;box-shadow:0 4px 14px rgba(5,150,105,0.3);width:100%;margin-top:10px}
        .btn-report:hover{box-shadow:0 6px 20px rgba(5,150,105,0.4)}
        .btn-secondary{background:#f3f4f6;color:#374151}
        .btn-secondary:hover{background:#e5e7eb}
        .btn-ex{background:#eff6ff;color:#2563eb;padding:8px 12px;font-size:11px;margin:4px;border-radius:6px}
        .btn-ex:hover{background:#2563eb;color:#fff}
        
        .btn-row{display:flex;gap:10px;margin-top:12px}
        
        /* Examples */
        .examples{margin-top:18px;padding-top:18px;border-top:1px solid #e5e7eb}
        .examples-label{font-size:11px;color:#6b7280;margin-bottom:8px;font-weight:600}
        
        /* Quick Results */
        .quick-results{margin-top:18px}
        .risk-card{padding:16px;border-radius:10px;margin-bottom:12px}
        .risk-critical{background:linear-gradient(135deg,#fef2f2,#fee2e2);border-left:4px solid #dc2626}
        .risk-high{background:linear-gradient(135deg,#fff7ed,#ffedd5);border-left:4px solid #ea580c}
        .risk-moderate{background:linear-gradient(135deg,#fffbeb,#fef3c7);border-left:4px solid #d97706}
        .risk-low{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-left:4px solid #16a34a}
        .risk-score{font-size:28px;font-weight:700;margin-bottom:4px}
        .risk-label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
        
        .int-list{max-height:300px;overflow-y:auto}
        .int-item{padding:12px;margin:8px 0;border-radius:8px;border-left:4px solid;font-size:13px}
        .int-item.contraindicated{background:#fef2f2;border-color:#dc2626}
        .int-item.major{background:#fff7ed;border-color:#ea580c}
        .int-item.moderate{background:#fffbeb;border-color:#d97706}
        .int-item.minor{background:#f0fdf4;border-color:#16a34a}
        .int-drugs{font-weight:600;color:#1f2937}
        .int-sev{font-size:10px;font-weight:700;text-transform:uppercase;color:#6b7280;margin-top:4px}
        
        /* Main Content Area */
        .content-area{display:flex;flex-direction:column;gap:20px}
        
        /* Tabs */
        .tabs{display:flex;gap:4px;padding:4px;background:#f3f4f6;border-radius:10px;width:fit-content}
        .tab{padding:10px 20px;border:none;background:transparent;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;color:#6b7280;transition:all 0.2s}
        .tab.active{background:#fff;color:#1f2937;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        .tab:hover:not(.active){color:#374151}
        
        /* Report View */
        .report-container{display:none;flex:1}
        .report-container.active{display:flex;flex-direction:column}
        .report-content{flex:1;padding:24px;overflow-y:auto;max-height:calc(100vh - 280px);line-height:1.7;font-size:14px}
        .report-content h2{color:#1e40af;margin:24px 0 12px;padding-bottom:8px;border-bottom:2px solid #dbeafe;font-size:18px}
        .report-content h3{color:#1f2937;margin:18px 0 10px;font-size:15px}
        .report-content ul{margin-left:20px;margin-bottom:12px}
        .report-content li{margin-bottom:6px}
        .report-content .citation{background:#eff6ff;padding:2px 8px;border-radius:4px;font-size:12px;font-family:monospace;color:#1d4ed8}
        .report-content .severity-tag{display:inline-block;padding:3px 10px;border-radius:4px;font-size:11px;font-weight:700;text-transform:uppercase}
        .report-content .sev-contraindicated{background:#fecaca;color:#991b1b}
        .report-content .sev-major{background:#fed7aa;color:#9a3412}
        .report-content .sev-moderate{background:#fde68a;color:#92400e}
        .report-content .sev-minor{background:#bbf7d0;color:#166534}
        .report-placeholder{text-align:center;padding:60px 20px;color:#9ca3af}
        .report-placeholder h3{color:#6b7280;margin-bottom:12px}
        .report-loading{display:flex;flex-direction:column;align-items:center;gap:16px;padding:60px}
        .report-loading .spinner{width:48px;height:48px;border:4px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .agent-steps{text-align:left;max-width:400px;margin-top:16px}
        .agent-step{padding:8px 12px;margin:4px 0;border-radius:6px;font-size:12px;display:flex;align-items:center;gap:8px}
        .agent-step.done{background:#dcfce7;color:#166534}
        .agent-step.active{background:#dbeafe;color:#1d4ed8;animation:pulse 1.5s infinite}
        .agent-step.pending{background:#f3f4f6;color:#9ca3af}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
        
        /* Chat View */
        .chat-container{display:none;flex:1;flex-direction:column}
        .chat-container.active{display:flex}
        .chat-messages{flex:1;padding:20px;overflow-y:auto;max-height:calc(100vh - 340px);min-height:400px}
        .message{margin-bottom:16px;display:flex}
        .message.user{justify-content:flex-end}
        .message.assistant{justify-content:flex-start}
        .message-content{max-width:75%;padding:14px 18px;border-radius:18px;font-size:14px;line-height:1.6}
        .user .message-content{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff;border-bottom-right-radius:4px}
        .assistant .message-content{background:#f3f4f6;color:#1f2937;border-bottom-left-radius:4px}
        .chat-input{padding:16px;border-top:1px solid #e5e7eb;display:flex;gap:12px}
        .chat-input input{flex:1;padding:14px 18px;border:2px solid #e5e7eb;border-radius:24px;font-size:14px}
        .chat-input input:focus{outline:none;border-color:#2563eb}
        .welcome{text-align:center;padding:50px 20px;color:#6b7280}
        .welcome h3{color:#374151;margin-bottom:12px;font-size:18px}
        .suggestions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:20px}
        .suggestion{background:#eff6ff;color:#2563eb;padding:10px 16px;border-radius:20px;font-size:12px;cursor:pointer;transition:0.2s}
        .suggestion:hover{background:#2563eb;color:#fff}
        
        /* Status Bar */
        .status-bar{text-align:center;padding:10px;font-size:11px;color:#6b7280;background:#f8fafc;border-top:1px solid #e5e7eb}
        .status-ready{color:#059669}
        .status-loading{color:#d97706}
        
        /* Modal */
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center}
        .modal.show{display:flex}
        .modal-content{background:#fff;border-radius:16px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
        .modal-header{font-size:18px;font-weight:600;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
        .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:#9ca3af}
        .model-option{padding:14px;margin:8px 0;border-radius:10px;cursor:pointer;border:2px solid #e5e7eb;transition:all 0.2s}
        .model-option:hover{border-color:#2563eb;background:#eff6ff}
        .model-option.active{border-color:#2563eb;background:#eff6ff}
        .model-name{font-weight:600;margin-bottom:4px}
        .model-desc{font-size:12px;color:#6b7280}
        .model-meta{font-size:11px;color:#9ca3af;margin-top:4px}
        
        /* Print styles */
        @media print{.sidebar,.tabs,.chat-input,.btn,.header{display:none!important}.report-content{max-height:none!important}}
        @media(max-width:1024px){.main-container{grid-template-columns:1fr}}
    </style>
</head>
<body>

<div class="header">
    <h1>üíä DDI Comprehensive Analyzer</h1>
    <p>Knowledge Graph-Powered Drug Interaction Analysis with AI Synthesis</p>
</div>

<div class="main-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <div class="panel">
            <div class="panel-header">
                <span>üîç Drug Regimen Analysis</span>
            </div>
            <div class="panel-content">
                <div class="drug-input">
                    <label>Enter Drug Names</label>
                    <input type="text" id="drug-input" placeholder="warfarin, aspirin, metoprolol, lisinopril" onkeypress="if(event.key==='Enter')quickCheck()">
                    <p class="hint">Separate multiple drugs with commas</p>
                </div>
                
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="quickCheck()">‚ö° Quick Check</button>
                    <button class="btn btn-secondary" onclick="clearInputs()">Clear</button>
                </div>
                
                <button class="btn btn-report" onclick="generateReport()">üìã Generate Comprehensive Report</button>
                
                <div class="examples">
                    <div class="examples-label">Try these examples:</div>
                    <button class="btn btn-ex" onclick="setDrugs('warfarin, aspirin, ibuprofen')">üî¥ High Risk</button>
                    <button class="btn btn-ex" onclick="setDrugs('metformin, lisinopril, amlodipine, metoprolol')">üü† CV Combo</button>
                    <button class="btn btn-ex" onclick="setDrugs('sertraline, tramadol, ondansetron')">üü° Serotonin Risk</button>
                    <button class="btn btn-ex" onclick="setDrugs('acetaminophen, omeprazole')">üü¢ Low Risk</button>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-header">‚ö° Quick Results</div>
            <div class="panel-content">
                <div id="quick-results">
                    <div class="report-placeholder">
                        <p>Enter drugs above and click Quick Check</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content Area -->
    <div class="content-area">
        <div class="panel" style="flex:1;display:flex;flex-direction:column">
            <div class="panel-header">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('report')">üìã Comprehensive Report</button>
                    <button class="tab" onclick="switchTab('chat')">üí¨ Chat Assistant</button>
                </div>
                <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px" onclick="showModelModal()" id="model-btn">ü§ñ Meditron 7B</button>
            </div>
            
            <!-- Report Tab -->
            <div class="report-container active" id="report-tab">
                <div class="report-content" id="report-content">
                    <div class="report-placeholder">
                        <h3>üìã Comprehensive Report</h3>
                        <p>Enter a drug regimen and click "Generate Comprehensive Report"</p>
                        <p style="margin-top:12px;font-size:12px">The report will include:</p>
                        <ul style="text-align:left;display:inline-block;margin-top:8px;font-size:13px">
                            <li>Drug-drug interactions with severity and mechanisms</li>
                            <li>Side effect overlap analysis</li>
                            <li>Protein target conflicts</li>
                            <li>Pathway analysis</li>
                            <li>Citations to DrugBank, SIDER, and other sources</li>
                            <li>AI-synthesized clinical recommendations</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Chat Tab -->
            <div class="chat-container" id="chat-tab">
                <div class="chat-messages" id="chat-messages">
                    <div class="welcome">
                        <h3>üí¨ DDI Chat Assistant</h3>
                        <p>Ask questions about drug interactions, mechanisms, and safety</p>
                        <div class="suggestions">
                            <div class="suggestion" onclick="askQuestion('What are the risks of combining warfarin with NSAIDs?')">Warfarin + NSAIDs</div>
                            <div class="suggestion" onclick="askQuestion('Explain serotonin syndrome risk factors')">Serotonin Syndrome</div>
                            <div class="suggestion" onclick="askQuestion('What are safer alternatives to aspirin for antiplatelet therapy?')">Aspirin Alternatives</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Ask about drug interactions..." onkeypress="if(event.key==='Enter')sendChat()">
                    <button class="btn btn-primary" onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="status-bar" id="status">Connecting...</div>

<!-- Model Selection Modal -->
<div class="modal" id="model-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span>Select LLM Model</span>
            <button class="modal-close" onclick="closeModelModal()">&times;</button>
        </div>
        <div id="model-list"></div>
    </div>
</div>

<script>
let currentModel = '';
let availableModels = {};
let chatHistory = [];

// Initialize
window.onload = function() {
    console.log('Page loaded, checking status...');
    checkStatus();
};

function checkStatus() {
    console.log('Fetching /status...');
    fetch('/status')
        .then(r => {
            console.log('Status response received');
            return r.json();
        })
        .then(d => {
            console.log('Status data:', d);
            const s = document.getElementById('status');
            if(d.loading) {
                s.className = 'status-bar status-loading';
                s.textContent = '‚è≥ ' + d.message;
                setTimeout(checkStatus, 1000);
            } else {
                s.className = 'status-bar status-ready';
                currentModel = d.current_model || '';
                availableModels = d.available_models || {};
                const modelInfo = availableModels[currentModel] || {};
                s.textContent = '‚úÖ ' + d.message + ' | ü§ñ ' + (modelInfo.name || 'Template');
                document.getElementById('model-btn').textContent = 'ü§ñ ' + (modelInfo.name?.split(' ')[0] || 'Model');
                console.log('UI updated successfully');
            }
        })
        .catch(e => {
            console.error('Status error:', e);
            document.getElementById('status').textContent = '‚ùå Connection failed - please refresh';
        });
}

function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.report-container, .chat-container').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + '-tab').classList.add('active');
}

function setDrugs(drugs) {
    document.getElementById('drug-input').value = drugs;
    quickCheck();
}

function clearInputs() {
    document.getElementById('drug-input').value = '';
    document.getElementById('quick-results').innerHTML = '<div class="report-placeholder"><p>Enter drugs above</p></div>';
}

function quickCheck() {
    const drugs = document.getElementById('drug-input').value.trim();
    if(!drugs) { alert('Please enter drug names'); return; }
    
    const results = document.getElementById('quick-results');
    results.innerHTML = '<div style="text-align:center;padding:20px"><div class="spinner" style="width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:#2563eb;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div><p style="margin-top:12px;color:#6b7280;font-size:12px">Analyzing...</p></div>';
    
    fetch('/analyze', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({drugs: drugs})
    })
    .then(r => r.json())
    .then(d => {
        if(d.error) {
            results.innerHTML = '<div style="color:#dc2626;padding:12px">‚ö†Ô∏è ' + d.error + '</div>';
            return;
        }
        displayQuickResults(d);
    })
    .catch(e => results.innerHTML = '<div style="color:#dc2626;padding:12px">‚ö†Ô∏è Error: ' + e + '</div>');
}

function displayQuickResults(d) {
    const results = document.getElementById('quick-results');
    const rc = d.risk_level.toLowerCase();
    const riskClass = rc === 'critical' ? 'risk-critical' : rc === 'high' ? 'risk-high' : rc === 'moderate' ? 'risk-moderate' : 'risk-low';
    
    let html = '<div class="risk-card ' + riskClass + '">';
    html += '<div class="risk-score">' + d.risk_score.toFixed(2) + '</div>';
    html += '<div class="risk-label">' + d.risk_level + ' Risk</div>';
    html += '<div style="margin-top:8px;font-size:12px;color:#6b7280">Drugs: ' + d.drugs.join(', ') + '</div>';
    html += '</div>';
    
    if(d.interactions.length === 0) {
        html += '<div style="text-align:center;padding:16px;color:#059669">‚úÖ No significant interactions detected</div>';
    } else {
        html += '<div style="font-size:12px;font-weight:600;margin-bottom:8px">Found ' + d.interactions.length + ' interaction(s):</div>';
        html += '<div class="int-list">';
        for(const i of d.interactions) {
            const sc = i.severity.toLowerCase().replace(/\s+/g, '-').replace('-interaction', '');
            html += '<div class="int-item ' + sc + '">';
            html += '<div class="int-drugs">' + i.drug1 + ' ‚Üî ' + i.drug2 + '</div>';
            html += '<div class="int-sev">' + i.severity + '</div>';
            html += '</div>';
        }
        html += '</div>';
    }
    
    results.innerHTML = html;
}

function generateReport() {
    const drugs = document.getElementById('drug-input').value.trim();
    if(!drugs) { alert('Please enter drug names first'); return; }
    
    // Switch to report tab
    switchTab('report');
    document.querySelector('.tab').click();
    
    const content = document.getElementById('report-content');
    content.innerHTML = `
        <div class="report-loading">
            <div class="spinner"></div>
            <div style="font-weight:600;color:#374151">Generating Comprehensive Report...</div>
            <div class="agent-steps">
                <div class="agent-step active" id="step-1">üìä Querying Knowledge Graph...</div>
                <div class="agent-step pending" id="step-2">üîç Analyzing Drug Interactions...</div>
                <div class="agent-step pending" id="step-3">üíä Checking Side Effect Overlap...</div>
                <div class="agent-step pending" id="step-4">üß¨ Examining Protein Targets...</div>
                <div class="agent-step pending" id="step-5">ü§ñ Synthesizing with LLM...</div>
                <div class="agent-step pending" id="step-6">üìã Formatting Report...</div>
            </div>
        </div>
    `;
    
    // Simulate agent steps
    setTimeout(() => updateStep(1, 2), 500);
    setTimeout(() => updateStep(2, 3), 1200);
    setTimeout(() => updateStep(3, 4), 2000);
    setTimeout(() => updateStep(4, 5), 2800);
    
    fetch('/comprehensive_report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({drugs: drugs})
    })
    .then(r => r.json())
    .then(d => {
        if(d.error) {
            content.innerHTML = '<div style="color:#dc2626;padding:24px">‚ö†Ô∏è Error: ' + d.error + '</div>';
            return;
        }
        updateStep(5, 6);
        setTimeout(() => {
            displayReport(d);
        }, 500);
    })
    .catch(e => content.innerHTML = '<div style="color:#dc2626;padding:24px">‚ö†Ô∏è Error: ' + e + '</div>');
}

function updateStep(done, active) {
    document.getElementById('step-' + done)?.classList.replace('active', 'done');
    document.getElementById('step-' + done)?.innerHTML = '‚úÖ ' + document.getElementById('step-' + done)?.textContent.slice(2);
    document.getElementById('step-' + active)?.classList.replace('pending', 'active');
}

function displayReport(d) {
    const content = document.getElementById('report-content');
    
    let html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
    html += '<div><h2 style="margin:0;border:none;padding:0">Comprehensive Drug Interaction Report</h2>';
    html += '<div style="color:#6b7280;font-size:12px;margin-top:4px">Generated: ' + new Date().toLocaleString() + '</div></div>';
    html += '<button class="btn btn-secondary" onclick="window.print()" style="padding:8px 16px">üñ®Ô∏è Print Report</button>';
    html += '</div>';
    
    // Risk Summary Card
    const rc = d.risk_level?.toLowerCase() || 'moderate';
    const riskClass = rc === 'critical' ? 'risk-critical' : rc === 'high' ? 'risk-high' : rc === 'moderate' ? 'risk-moderate' : 'risk-low';
    html += '<div class="risk-card ' + riskClass + '" style="margin-bottom:24px">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center">';
    html += '<div><div class="risk-label">Overall Risk Assessment</div><div class="risk-score">' + d.risk_level + '</div></div>';
    html += '<div style="text-align:right"><div style="font-size:12px;color:#6b7280">Risk Score</div><div style="font-size:32px;font-weight:700">' + (d.risk_score?.toFixed(2) || 'N/A') + '</div></div>';
    html += '</div>';
    html += '<div style="margin-top:12px;font-size:13px"><strong>Regimen:</strong> ' + (d.drugs?.join(', ') || 'N/A') + '</div>';
    
    // Metadata
    if(d.metadata) {
        html += '<div style="margin-top:8px;font-size:11px;color:#6b7280">';
        html += 'Interactions: ' + (d.metadata.interaction_count || 0) + ' | ';
        html += 'Shared Side Effects: ' + (d.metadata.shared_side_effects || 0) + ' | ';
        html += 'Shared Proteins: ' + (d.metadata.shared_proteins || 0);
        html += '</div>';
    }
    html += '</div>';
    
    // LLM Synthesized Report (if available)
    if(d.llm_report && !d.llm_report.startsWith('[')) {
        html += '<div style="background:#eff6ff;padding:16px;border-radius:8px;margin-bottom:24px;border-left:4px solid #2563eb">';
        html += '<h3 style="margin:0 0 12px 0;color:#1e40af">ü§ñ AI-Synthesized Clinical Summary</h3>';
        html += '<div style="font-size:13px;color:#374151">' + formatLLMReport(d.llm_report) + '</div>';
        html += '</div>';
    }
    
    // Always show raw KG data with full source material
    if(d.kg_data) {
        html += '<div style="border-top:2px solid #e5e7eb;margin-top:24px;padding-top:24px">';
        html += '<h2 style="margin-bottom:16px;color:#1f2937">üìä Source Database Evidence</h2>';
        html += formatRawKGData(d.kg_data);
        html += '</div>';
    }
    
    content.innerHTML = html;
}

function formatLLMReport(report) {
    // Convert markdown-style formatting to HTML
    let html = report
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h2>$1</h2>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/\[(DB\d+)\]/g, '<span class="citation">$1</span>')
        .replace(/\[(UMLS:[A-Z0-9]+)\]/g, '<span class="citation">$1</span>')
        .replace(/Contraindicated/gi, '<span class="severity-tag sev-contraindicated">Contraindicated</span>')
        .replace(/Major interaction/gi, '<span class="severity-tag sev-major">Major</span>')
        .replace(/Moderate interaction/gi, '<span class="severity-tag sev-moderate">Moderate</span>')
        .replace(/Minor interaction/gi, '<span class="severity-tag sev-minor">Minor</span>');
    
    return '<div class="llm-report">' + html + '</div>';
}

function formatRawKGData(kg) {
    let html = '';
    
    // Drug Profiles Section
    if(kg.drug_profiles?.length > 0) {
        html += '<h2>Drug Profiles</h2>';
        for(const drug of kg.drug_profiles) {
            html += '<div style="background:#f8fafc;padding:16px;margin:12px 0;border-radius:8px;border-left:4px solid #2563eb">';
            html += '<div style="display:flex;justify-content:space-between;align-items:start">';
            html += '<h3 style="margin:0 0 8px 0;color:#1e40af">' + drug.name + '</h3>';
            html += '<span class="citation">' + drug.drugbank_id + '</span>';
            html += '</div>';
            if(drug.type) html += '<div style="font-size:12px;color:#6b7280;margin-bottom:8px"><strong>Type:</strong> ' + drug.type + ' | <strong>Groups:</strong> ' + (drug.groups || 'N/A') + '</div>';
            if(drug.indication) {
                html += '<div style="margin:8px 0"><strong>Indication:</strong></div>';
                html += '<div style="font-size:13px;color:#374151;background:#fff;padding:10px;border-radius:4px;max-height:150px;overflow-y:auto">' + drug.indication.substring(0, 800) + (drug.indication.length > 800 ? '...' : '') + '</div>';
            }
            if(drug.mechanism_of_action) {
                html += '<div style="margin:8px 0"><strong>Mechanism of Action:</strong></div>';
                html += '<div style="font-size:13px;color:#374151;background:#fff;padding:10px;border-radius:4px;max-height:150px;overflow-y:auto">' + drug.mechanism_of_action.substring(0, 800) + (drug.mechanism_of_action.length > 800 ? '...' : '') + '</div>';
            }
            if(drug.drugbank_url) html += '<div style="margin-top:8px"><a href="' + drug.drugbank_url + '" target="_blank" style="color:#2563eb;font-size:12px">View on DrugBank ‚Üí</a></div>';
            html += '</div>';
        }
    }
    
    // Drug Interactions Section
    html += '<h2>Drug-Drug Interactions</h2>';
    if(kg.interactions?.length > 0) {
        for(const i of kg.interactions) {
            const sevClass = i.severity.toLowerCase().includes('contraindicated') ? 'sev-contraindicated' : 
                            i.severity.toLowerCase().includes('major') ? 'sev-major' : 
                            i.severity.toLowerCase().includes('moderate') ? 'sev-moderate' : 'sev-minor';
            html += '<div style="background:#fff;padding:16px;margin:12px 0;border-radius:8px;border:1px solid #e5e7eb">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
            html += '<strong style="font-size:15px">' + i.drug1 + ' ‚Üî ' + i.drug2 + '</strong>';
            html += '<span class="severity-tag ' + sevClass + '">' + i.severity + '</span>';
            html += '</div>';
            if(i.description) {
                html += '<div style="font-size:13px;color:#374151;background:#f8fafc;padding:12px;border-radius:4px;margin:8px 0;line-height:1.6">' + i.description + '</div>';
            }
            html += '<div style="font-size:11px;color:#6b7280;margin-top:8px">';
            html += '<span class="citation">' + i.drug1_id + '</span> + <span class="citation">' + i.drug2_id + '</span>';
            html += ' | Source: ' + i.source;
            if(i.interaction_url) html += ' | <a href="' + i.interaction_url + '" target="_blank" style="color:#2563eb">View details</a>';
            html += '</div></div>';
        }
    } else {
        html += '<p style="color:#059669;padding:16px;background:#f0fdf4;border-radius:8px">‚úÖ No direct drug-drug interactions found in the database.</p>';
    }
    
    // Side Effects Section
    if(kg.side_effects?.length > 0) {
        html += '<h2>Overlapping Side Effects (SIDER Database)</h2>';
        html += '<p style="font-size:13px;color:#6b7280;margin-bottom:12px">Side effects shared by multiple drugs in the regimen may be amplified:</p>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:12px">';
        for(const se of kg.side_effects.slice(0, 15)) {
            html += '<div style="background:#fff7ed;padding:12px;border-radius:8px;border-left:3px solid #ea580c">';
            html += '<div style="font-weight:600;margin-bottom:4px">' + se.name + '</div>';
            html += '<div style="font-size:12px;color:#6b7280">Shared by: ' + se.drugs.join(', ') + '</div>';
            html += '<div style="font-size:11px;color:#9a3412;margin-top:4px">' + se.risk_note + '</div>';
            html += '<div style="font-size:10px;color:#6b7280;margin-top:4px"><span class="citation">' + se.umls_cui + '</span></div>';
            html += '</div>';
        }
        html += '</div>';
        if(kg.side_effects.length > 15) {
            html += '<p style="font-size:12px;color:#6b7280;margin-top:12px">+ ' + (kg.side_effects.length - 15) + ' more shared side effects</p>';
        }
    }
    
    // Protein Targets Section
    if(kg.proteins?.length > 0) {
        html += '<h2>Shared Protein Targets (DrugBank/UniProt)</h2>';
        html += '<p style="font-size:13px;color:#6b7280;margin-bottom:12px">Drugs targeting the same proteins may have additive effects or compete:</p>';
        for(const p of kg.proteins.slice(0, 10)) {
            html += '<div style="background:#eff6ff;padding:14px;margin:10px 0;border-radius:8px;border-left:3px solid #2563eb">';
            html += '<div style="display:flex;justify-content:space-between;align-items:start">';
            html += '<div><strong>' + p.name + '</strong>';
            if(p.gene_name) html += ' <span style="font-size:12px;color:#6b7280">(' + p.gene_name + ')</span>';
            html += '</div>';
            html += '<span class="citation">' + p.id + '</span>';
            html += '</div>';
            html += '<div style="font-size:12px;color:#374151;margin:6px 0">Targeted by: <strong>' + p.drugs.join(', ') + '</strong></div>';
            if(p.general_function) {
                html += '<div style="font-size:12px;margin:6px 0"><strong>Function:</strong> ' + p.general_function.substring(0, 300) + '</div>';
            }
            if(p.specific_function) {
                html += '<div style="font-size:12px;color:#4b5563;margin:6px 0">' + p.specific_function.substring(0, 400) + '</div>';
            }
            if(p.cellular_location) html += '<div style="font-size:11px;color:#6b7280"><strong>Location:</strong> ' + p.cellular_location + '</div>';
            if(p.uniprot_url) html += '<div style="margin-top:6px"><a href="' + p.uniprot_url + '" target="_blank" style="color:#2563eb;font-size:11px">View on UniProt ‚Üí</a></div>';
            html += '</div>';
        }
    }
    
    // Pathways Section
    if(kg.pathways?.length > 0) {
        html += '<h2>Shared Metabolic Pathways</h2>';
        html += '<ul>';
        for(const pw of kg.pathways.slice(0, 10)) {
            html += '<li><strong>' + pw.id + '</strong> - Drugs: ' + pw.drugs.join(', ');
            if(pw.kegg_url) html += ' <a href="' + pw.kegg_url + '" target="_blank" style="color:#2563eb;font-size:11px">[KEGG]</a>';
            html += '</li>';
        }
        html += '</ul>';
    }
    
    // Sources Section
    if(kg.metadata?.sources) {
        html += '<h2>Database Sources</h2>';
        html += '<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));gap:10px">';
        for(const src of kg.metadata.sources) {
            html += '<div style="background:#f8fafc;padding:10px;border-radius:6px">';
            html += '<div style="font-weight:600;font-size:13px">' + src.name + '</div>';
            html += '<div style="font-size:11px;color:#6b7280">' + src.description + '</div>';
            html += '<a href="' + src.url + '" target="_blank" style="font-size:11px;color:#2563eb">' + src.url + '</a>';
            html += '</div>';
        }
        html += '</div>';
    }
    
    return html;
}

// Chat Functions
function askQuestion(q) {
    document.getElementById('chat-input').value = q;
    sendChat();
}

function sendChat() {
    const input = document.getElementById('chat-input');
    const msg = input.value.trim();
    if(!msg) return;
    
    input.value = '';
    addMessage('user', msg);
    chatHistory.push({role: 'user', content: msg});
    
    // Typing indicator
    const typing = document.createElement('div');
    typing.className = 'message assistant';
    typing.id = 'typing';
    typing.innerHTML = '<div class="message-content"><div style="display:flex;gap:4px"><span style="width:8px;height:8px;background:#6b7280;border-radius:50%;animation:bounce 1.4s infinite"></span><span style="width:8px;height:8px;background:#6b7280;border-radius:50%;animation:bounce 1.4s infinite 0.16s"></span><span style="width:8px;height:8px;background:#6b7280;border-radius:50%;animation:bounce 1.4s infinite 0.32s"></span></div></div>';
    document.getElementById('chat-messages').appendChild(typing);
    scrollChat();
    
    fetch('/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: msg, history: chatHistory.slice(-10)})
    })
    .then(r => r.json())
    .then(d => {
        document.getElementById('typing')?.remove();
        if(d.error) {
            addMessage('assistant', '‚ö†Ô∏è ' + d.error);
        } else {
            addMessage('assistant', d.response);
            chatHistory.push({role: 'assistant', content: d.response});
        }
    })
    .catch(e => {
        document.getElementById('typing')?.remove();
        addMessage('assistant', '‚ö†Ô∏è Error: ' + e.message);
    });
}

function addMessage(role, content) {
    const messages = document.getElementById('chat-messages');
    const welcome = messages.querySelector('.welcome');
    if(welcome) welcome.remove();
    
    const div = document.createElement('div');
    div.className = 'message ' + role;
    
    let formatted = content
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/`(.+?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
    
    div.innerHTML = '<div class="message-content">' + formatted + '</div>';
    messages.appendChild(div);
    scrollChat();
}

function scrollChat() {
    const messages = document.getElementById('chat-messages');
    messages.scrollTop = messages.scrollHeight;
}

// Model Modal
function showModelModal() {
    const modal = document.getElementById('model-modal');
    const list = document.getElementById('model-list');
    list.innerHTML = '';
    
    for(const [key, info] of Object.entries(availableModels)) {
        const isActive = key === currentModel;
        const div = document.createElement('div');
        div.className = 'model-option' + (isActive ? ' active' : '');
        div.innerHTML = '<div class="model-name">' + (isActive ? '‚úì ' : '') + info.name + '</div>' +
                        '<div class="model-desc">' + info.description + '</div>' +
                        '<div class="model-meta">Parameters: ' + info.params + ' | Size: ' + info.size + '</div>';
        div.onclick = () => selectModel(key);
        list.appendChild(div);
    }
    
    modal.classList.add('show');
}

function closeModelModal() {
    document.getElementById('model-modal').classList.remove('show');
}

function selectModel(key) {
    fetch('/set_model', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({model: key})
    })
    .then(r => r.json())
    .then(d => {
        if(d.success) {
            currentModel = key;
            closeModelModal();
            checkStatus();
        } else {
            alert('Error: ' + d.error);
        }
    });
}
</script>
</body>
</html>